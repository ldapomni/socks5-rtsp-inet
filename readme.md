# RTSP Tunnel Project

SOCKS5 прокси-туннель через протокол RTSP с поддержкой TCP и QUIC. 

## Состав проекта

Проект состоит из трех основных компонентов:

1.  **Server (`server.exe`)**: Принимает входящие туннельные соединения.
2.  **Client (`client.exe`)**: Подключается к серверу, создает пул туннелей и предоставляет локальный SOCKS5 прокси.
3.  **Stats Dashboard (`stats.exe`)**: Отдельная утилита для мониторинга состояния туннелей в реальном времени.

---

## 1. Server (Сервер)

Сервер слушает входящие соединения по протоколам TCP и QUIC на указанном порту.

### Ключи запуска:
- `-port` (default: `8554`): Порт для RTSP/QUIC соединений.
- `-udp-port` (default: `8555`): Порт для прямого зашифрованного UDP-прокси (Direct UDP).
- `-tcp-buffer` (default: `32`): Размер TCP буферов в КБ.
- `-logfile`: Путь к файлу логов.
- `-loglevel` (default: `info`): Уровень логирования (`debug`, `info`, `error`).

### Пример:
```powershell
./bin/server.exe -port 8554 -loglevel debug
```

---

## 2. Client (Клиент)

Клиент создает SOCKS5 прокси и устанавливает один или несколько туннелей до сервера.

### Ключи запуска:
- `-ip` (default: `127.0.0.1`): IP адрес сервера.
- `-port` (default: `8554`): Порт сервера.
- `-transport` (default: `tcp`): Протокол туннеля (`tcp` или `quic`). Рекомендуется `quic` для игр.
- `-socks-port` (default: `1080`): Порт локального SOCKS5 прокси.
- `-tunnels` (default: `4`): Количество параллельных туннелей до сервера.
- `-users`: Путь к файлу с пользователями в формате `user:pass` или `user:pass:stat`.
- `-tcp-buffer` (default: `32`): Размер TCP буферов в КБ.
- `-stats-addr` (default: `127.0.0.1:8080`): Адрес для внутреннего API статистики.
- `-loglevel` (default: `info`): Уровень логирования.

### Пример (QUIC + Оптимизация для игр):
```powershell
./bin/client.exe -ip 1.2.3.4 -transport quic -tunnels 4 -users users.txt
```

---

## 3. Stats Dashboard (Мониторинг)

Позволяет визуально отслеживать нагрузку, пинг (RTT) и количество переданных данных.

### Ключи запуска:
- `-addr` (default: `127.0.0.1:8080`): Адрес API статистики клиента.
- `-user`: Логин (требуется только для удаленного подключения).
- `-pass`: Пароль (требуется только для удаленного подключения).
- `-interval` (default: `1000`): Интервал опроса статистики в миллисекундах.
- `-json`: Вывод статистики в формате JSON (для скриптов).
- `-add-user "user:pass[:stat][:admin]"`: Удаленное добавление нового пользователя (требуются права `:admin`).

### Особенности авторизации:
- **Локально**: Если `stats.exe` запущен на том же ПК, что и клиент, авторизация не требуется.
- **Удаленно**: Требуется пользователь, у которого в файле `-users` стоит пометка `:stat` (например, `admin:12345:stat`).

### Пример:
```powershell
./bin/stats.exe -addr 1.2.3.4:8080 -user admin -pass 12345
```

---

## Настройка UDP портов (Важно для скорости)

Для достижения минимального пинга крайне важно убедиться, что UDP трафик не блокируется фаерволом.

1.  **Порт Туннеля (UDP)**: Тот же, что в параметре `-port` (по умолчанию `8554`). Используется протоколом **QUIC**. Через него идут данные туннеля, когда выбран `-transport quic`.
2.  **Порт Direct UDP (UDP)**: По умолчанию `8555` (параметр `-udp-port`). Используется для самого быстрого метода проброса UDP «напрямую» в обход основного туннеля.

> [!IMPORTANT]
> Если эти UDP-порты закрыты на сервере, клиент может переключиться на обычный TCP-туннель (если не форсирован `quic`), но это приведет к значительному росту задержек (пинг будет «скакать»).

---

### Формат записи:
```text
user1:password123             # Обычный доступ
admin:topsecret:stat:admin    # Доступ + Статистика + Администрирование
$2a$10$...:hashedPass:stat    # Поддержка bcrypt хешей (автоопределение)
```

- **Безопасность**: Клиент поддерживает хранение паролей в виде `bcrypt` хешей. Если строка начинается с `$2a$`, она считается хешем.
- **Авто-создание**: Если файл `-users` отсутствует, при первом запуске будет создан `users.txt` с пользователем `admin:admin:stat:admin` (пароль будет сразу захеширован).

---

## Особенности и оптимизация
- **Раздельная статистика**: Мониторинг TCP и UDP трафика (байты и пакеты) в реальном времени.
- **Remote User Management**: Добавление пользователей "на лету" через API клиента без перезагрузки.
- **QUIC Datagrams**: UDP трафик передается через ненадёжный транспорт QUIC, что исключает задержки от переотправки потерянных пакетов.
- **0-RTT**: Мгновенное возобновление сессии при переподключении.
- **TCP NoDelay**: Отключение алгоритма Нагла для всех TCP соединений.
- **Конфигурируемые буферы**: Возможность уменьшить буферы для борьбы с Bufferbloat.
